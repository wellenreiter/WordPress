<?php class wpSEO{public static function init(){add_action('init', array(__CLASS__, 'switch_lang')); add_action('init', array('wpSEO_Feedback', 'rules')); add_action('network_admin_notices', array('wpSEO_Feedback', 'network')); add_action('admin_notices', array('wpSEO_Feedback', 'admin')); add_action('admin_menu', array(__CLASS__, 'init_menu')); add_action('init', array('wpSEO_Update', 'init')); add_action('init', array('wpSEO_License', 'shame')); add_action('wpmu_new_blog', array(__CLASS__, 'install_later')); add_action('delete_blog', array(__CLASS__, 'uninstall_later')); if($pagenow=self::get_page()){if(!in_array($pagenow, array('index', 'edit-tags', 'edit', 'post', 'post-new', 'plugins', 'admin-post', 'options-general', 'media', 'media-upload', 'media-new'))){return;}}if((wpSEO_Feedback::get('critical')or wpSEO_License::expired())&& $pagenow !='plugins'){return;}$options=wpSEO_Options::get(); switch($pagenow){case 'index': if($options['misc_monitor']){require_once WPSEO_DIR. '/inc/dashboard.class.php'; add_action('wp_dashboard_setup', array('wpSEO_Dashboard', 'init'));}break; case 'media': if($options['misc_attachment'] && $options['misc_attachment_complete']){require_once WPSEO_DIR. '/inc/media.class.php'; wpSEO_Media::complete();}break; case 'media-new': case 'media-upload': if($options['misc_attachment']){require_once WPSEO_DIR. '/inc/media.class.php'; add_filter('attachment_fields_to_save', array('wpSEO_Media', 'rename'), 10,2); if($options['misc_attachment_complete']){wpSEO_Media::complete();}}break; case 'edit-tags': if($options['tax_manually']){require_once WPSEO_DIR. '/inc/tax.class.php'; add_action('admin_init', array('wpSEO_Tax', 'init'));}break; case 'edit': if($options['title_column'] or $options['desc_column'] or $options['key_column'] or $options['robots_column'] or $options['canonical_column'] or $options['redirect_column']){require_once WPSEO_DIR. '/inc/meta.class.php'; add_filter('manage_posts_columns', array('wpSEO_Meta', 'add_columns')); add_filter('manage_pages_columns', array('wpSEO_Meta', 'add_columns')); add_filter('manage_posts_custom_column', array('wpSEO_Meta', 'show_columns')); add_filter('manage_pages_custom_column', array('wpSEO_Meta', 'show_columns'));}break; case 'post': case 'post-new': if($options['key_button']){add_action('init', array(__CLASS__, 'init_mce'));}if($options['title_manually'] or $options['desc_manually'] or $options['key_manually'] or $options['noindex_manually'] or $options['canonical_manually'] or $options['redirect_manually']){require_once WPSEO_DIR. '/inc/meta.class.php'; add_action('add_meta_boxes', array('wpSEO_Meta', 'init')); add_action('save_post', array('wpSEO_Meta', 'update')); add_action('delete_post', array('wpSEO_Meta', 'delete'));}break; case 'plugins': add_action('after_plugin_row_' .WPSEO_BASE, array(__CLASS__, 'set_input')); add_action('init', array('wpSEO_License', 'verify')); add_filter('plugin_action_links_' .WPSEO_BASE, array(__CLASS__, 'set_links')); add_filter('plugin_row_meta', array(__CLASS__, 'set_rows'), 10, 2); break; case 'admin-post': case 'options-general': require_once WPSEO_DIR. '/inc/gui.class.php'; remove_action('admin_menu', array(__CLASS__, 'init_menu')); add_action('admin_menu', array('wpSEO_GUI', 'init_menu')); add_action('admin_post_save_wpseo_changes', array('wpSEO_GUI', 'save_changes')); break; default: break;}}public static function install($is_network){if($is_network){$ids=self::_get_blog_ids(); foreach($ids as $id){switch_to_blog((int)$id); self::_install_backend();}restore_current_blog();}else{self::_install_backend();}}public static function install_later($id){if(!self::is_network_active()){return;}switch_to_blog((int)$id); self::_install_backend(); restore_current_blog();}private static function _install_backend(){wpSEO_Options::init(); delete_transient('wpseo');}public static function uninstall(){if(is_network_admin()){$ids=self::_get_blog_ids(); foreach($ids as $id){switch_to_blog($id); self::_uninstall_backend();}restore_current_blog();}else{self::_uninstall_backend();}}public static function uninstall_later($id){if(!self::is_network_active()){return;}switch_to_blog((int)$id); self::_uninstall_backend(); restore_current_blog();}private static function _uninstall_backend(){global $wpdb; delete_option('wpseo'); delete_transient('wpseo'); $wpdb->query("DELETE FROM `" .$wpdb->options. "` WHERE `option_name` LIKE('wpseo_%_%')"); $wpdb->query("OPTIMIZE TABLE `" .$wpdb->options. "`");}public static function update(){self::_update_backend();}private static function _update_backend(){delete_transient('wpseo');}private static function _get_blog_ids(){global $wpdb; return $wpdb->get_col($wpdb->prepare("SELECT blog_id FROM `$wpdb->blogs`"));}public static function is_network_active(){if(!function_exists('is_plugin_active_for_network')){require_once(ABSPATH. 'wp-admin/includes/plugin.php');}return is_plugin_active_for_network(WPSEO_BASE);}public static function init_mce(){if(!user_can_richedit()or !current_user_can('edit_pages')or !current_user_can('edit_posts')){return false;}add_filter('mce_external_plugins', create_function('$data', '$data["wpseo"]=plugins_url(dirname(WPSEO_BASE). "/js/editor.js"); return $data;')); add_filter('mce_buttons', create_function('$data', 'array_push($data, "separator", "wpseo"); return $data;'));}public static function init_menu(){if(!current_user_can('manage_options')or wpSEO_Feedback::get('critical')or wpSEO_License::expired()){return;}add_options_page('wpSEO', '<img src="' .self::plugin_url('img/icon.png'). '" alt="wpSEO" />wpSEO', 'manage_options', 'wpseo', array('wpSEO_GUI', 'show_page'));}public static function plugin_url($url){return plugins_url(sprintf('%s/%s', dirname(WPSEO_BASE), $url));}public static function get_page(){return(empty($GLOBALS['pagenow'])? 'index' : basename($GLOBALS['pagenow'], '.php'));}public static function is_page($name){return(empty($name)? false :(wpSEO::get_page()==$name));}public function check_security($nonce='_wpseo_nonce'){if(!current_user_can('manage_options')){wp_die(__('Cheatin&#8217; uh?'));}check_admin_referer($nonce);}public static function set_links($data){$output=array_filter($data, create_function('$f', 'return !strpos($f, "plugin-editor.php");')); if(!(!current_user_can('manage_options')or wpSEO_Feedback::get('critical')or wpSEO_License::expired())){$output=array_merge($output, array(sprintf('<a href="%s">%s</a>', add_query_arg(array('page'=> 'wpseo'), admin_url('options-general.php')), __('Settings'))));}return $output;}public static function set_rows($data, $page){if(WPSEO_BASE !=$page){return $data;}if(is_multisite()&& !is_network_admin()){return $data;}if(self::has_cap('manage_plugins')&& wpSEO_License::valid()){return array_merge($data, array(sprintf('<a href="%s">%s</a>', add_query_arg(array('_wpseo_action'=> 'rekey'), network_admin_url('plugins.php')), esc_html__('Enter another key', 'wpseo'))));}return $data;}public static function set_input(){if(!self::has_cap('manage_plugins')or(is_multisite()&& !is_network_admin())){return false;}if(wpSEO_License::invalid()or(!empty($_GET['_wpseo_action'])&& $_GET['_wpseo_action']=='rekey')){?> 			<tr class="plugin-update-tr">	  			<td colspan="4">	  				<div class="update-message">	  					<form action="<?php echo network_admin_url('plugins.php')?>" method="post">							<input type="hidden" name="_wpseo_action" value="verify" />							<?php wp_nonce_field('_wpseo_nonce')?>				  				<strong>			  					<label for="_wpseo_key">			  						<?php esc_html_e('wpSEO license key', 'wpseo')?>:			  					</label>			  				</strong>			  				<input type="text" name="_wpseo_key" id="_wpseo_key" class="regular-text code" />			  				<input type="submit" name="submit" value="<?php esc_html_e('Activate', 'wpseo')?>" class="button-primary action" />			  				<button class="button-secondary action" onclick="window.location='<?php echo network_admin_url('plugins.php')?>';return false;"><?php esc_html_e('Cancel', 'wpseo')?></button>			  			</form>	  				</div>	  			</td>		  	</tr>		<?php }}public static function is_wp($version){return version_compare($GLOBALS['wp_version'], $version. 'alpha', '>=');}public static function is_php($version){return version_compare(phpversion(), $version, '>=');}public static function redirect_referer($params=array()){wp_safe_redirect(add_query_arg($params, wp_get_referer())); die();}public static function switch_lang(){$current=$GLOBALS['locale']; $GLOBALS['locale']=wpSEO_Base::get_lang(); load_plugin_textdomain('wpseo', '', dirname(WPSEO_BASE). '/lang'); $GLOBALS['locale']=$current;}public static function help_icon($id, $return=false){if(!empty($id)&& $id > 1){$icon=sprintf('<a href="http://helpdesk.wpseo.de/?p=%d" class="help" target="_blank">[?]</a>', esc_attr($id)); if($return){return $icon;}echo $icon;}}public static function has_cap($type){switch($type){case 'manage_plugins': if(is_multisite()){if(is_network_admin()){if(!current_user_can('manage_network_plugins')){return false;}}else{if(!current_user_can('activate_plugins')){return false;}}}else{if(!current_user_can('activate_plugins')){return false;}}break; case 'update_plugins': if(is_multisite()){if(is_network_admin()){if(!current_user_can('manage_network_plugins')){return false;}}else{return false;}}else{if(!current_user_can('update_plugins')){return false;}}break; default: break;}return true;}}require_once WPSEO_DIR. '/inc/license.class.php'; require_once WPSEO_DIR. '/inc/feedback.class.php'; require_once WPSEO_DIR. '/inc/transients.class.php'; require_once WPSEO_DIR. '/inc/options.class.php'; require_once WPSEO_DIR. '/inc/update.class.php'; require_once WPSEO_DIR. '/inc/base.class.php'; require_once WPSEO_DIR. '/inc/vars.class.php';